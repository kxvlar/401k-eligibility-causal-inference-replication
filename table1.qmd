---
title: "Untitled"
format: html
---


```{r}
library(dplyr)
library(tidyr)

to_num <- function(x) suppressWarnings(as.numeric(x))

## ----------------------------------------------------------
## 1. Load raw files
## ----------------------------------------------------------

t3  <- readRDS("data/raw/rds_down/t3.rds")
t6  <- readRDS("data/raw/rds_down/t6.rds")
t9  <- readRDS("data/raw/rds_down/t9.rds")
t12 <- readRDS("data/raw/rds_down/t12.rds")

t7  <- readRDS("data/raw/rds_down/t7.rds")
w7  <- readRDS("data/raw/rds_down/w7.rds")
w8  <- readRDS("data/raw/rds_down/w8.rds")
w9  <- readRDS("data/raw/rds_down/w9.rds")

id_vars <- c("SSUID","SHHADID","EENTAID","EPPPNUM")

## ----------------------------------------------------------
## 2. Assets: build taltb6, thhira6, otherassets6, etc.
##     Names are chosen to line up with the Stata do-file.
## ----------------------------------------------------------

make_assets_wave <- function(df, wave_num) {
  df %>%
    transmute(
      SSUID, SHHADID, EENTAID, EPPPNUM,
      wave = wave_num,
      # 401(k) balance
      taltb      = to_num(TALTB),
      # IRA balance
      thhira     = to_num(THHIRA),
      # Other financial assets (interest, stocks, "other" assets)
      otherassets = to_num(THHINTBK) +
                    to_num(THHINTOT) +
                    to_num(RHHSTK)   +
                    to_num(THHOTAST),
      # secured & unsecured debt
      thhscdbt   = to_num(THHSCDBT),
      rhhuscbt   = to_num(RHHUSCBT),
      # car values: sum over up to 3 cars
      tcarval    = to_num(TCARVAL1) +
                   to_num(TCARVAL2) +
                   to_num(TCARVAL3)
    )
}

assets_long <- bind_rows(
  make_assets_wave(t3,  3),
  make_assets_wave(t6,  6),
  make_assets_wave(t9,  9),
  make_assets_wave(t12, 12)
)

assets_wide <- assets_long %>%
  pivot_wider(
    id_cols    = all_of(id_vars),
    names_from = wave,
    values_from = c(taltb, thhira, otherassets, thhscdbt, rhhuscbt, tcarval),
    names_sep = ""
  )
# This gives: taltb3, taltb6, taltb9, taltb12, etc.
# Wave 6 variables correspond to the Table 1 row (taltb6 → 401(k) assets).

## ----------------------------------------------------------
## 3. Wave 7 core stuff (one record per person: SREFMON==4)
## ----------------------------------------------------------

core7 <- w7 %>%
  filter(SREFMON == 4) %>%  # this is how w7v2 is built in Stata
  transmute(
    SSUID, SHHADID, EENTAID, EPPPNUM,
    tage      = to_num(TAGE),
    wpfinwgt  = to_num(WPFINWGT),
    eclwrk1   = to_num(ECLWRK1),
    efnp      = to_num(EFNP),
    esex      = to_num(ESEX),
    tempall1  = to_num(TEMPALL1),
    ejbind1   = to_num(EJBIND1),
    tsjdate1  = to_num(TSJDATE1),
    srotaton  = to_num(SROTATON)
  )

## ----------------------------------------------------------
## 3a. Calculate Year 1 household income (sum of all 12 months)
##     Wave 7 (months 1-4) + Wave 8 (months 1-4) + Wave 9 (months 1-4)
## ----------------------------------------------------------

# Wave 7 income by reference month
w7_inc <- w7 %>%
  select(SSUID, SHHADID, EENTAID, EPPPNUM, SREFMON, THTOTINC) %>%
  mutate(
    THTOTINC = to_num(THTOTINC),
    month = paste0("w7_", SREFMON)
  ) %>%
  select(-SREFMON) %>%
  pivot_wider(names_from = month, values_from = THTOTINC, id_cols = all_of(id_vars))

# Wave 8 income by reference month
w8_inc <- w8 %>%
  select(SSUID, SHHADID, EENTAID, EPPPNUM, SREFMON, THTOTINC) %>%
  mutate(
    THTOTINC = to_num(THTOTINC),
    month = paste0("w8_", SREFMON)
  ) %>%
  select(-SREFMON) %>%
  pivot_wider(names_from = month, values_from = THTOTINC, id_cols = all_of(id_vars))

# Wave 9 income by reference month
w9_inc <- w9 %>%
  select(SSUID, SHHADID, EENTAID, EPPPNUM, SREFMON, THTOTINC) %>%
  mutate(
    THTOTINC = to_num(THTOTINC),
    month = paste0("w9_", SREFMON)
  ) %>%
  select(-SREFMON) %>%
  pivot_wider(names_from = month, values_from = THTOTINC, id_cols = all_of(id_vars))

# Merge all income months and sum to get Year 1 income
year1_income <- w7_inc %>%
  full_join(w8_inc, by = id_vars) %>%
  full_join(w9_inc, by = id_vars) %>%
  mutate(
    # Sum all 12 months (w7_1 through w7_4, w8_1 through w8_4, w9_1 through w9_4)
    hh_inc_year = rowSums(select(., starts_with("w7_"), starts_with("w8_"), starts_with("w9_")), 
                         na.rm = FALSE)  # Keep as NA if any month is missing
  ) %>%
  select(all_of(id_vars), hh_inc_year)

## ----------------------------------------------------------
## 4. Topical module 7: 401(k) eligibility & reasons
## ----------------------------------------------------------

tm7 <- t7 %>%
  transmute(
    SSUID, SHHADID, EENTAID, EPPPNUM,
    e1taxdef = to_num(E1TAXDEF),
    e2taxdef = to_num(E2TAXDEF),
    e3taxdef = to_num(E3TAXDEF),
    enoina03 = to_num(ENOINA03),   # reason not covered: haven’t worked long enough (plan A)
    enoinb03 = to_num(ENOINB03),   # reason not covered: haven’t worked long enough (plan B)
    etdeffen = to_num(ETDEFFEN)    # firm offers any tax-deferred plan
  )

## ----------------------------------------------------------
## 5. Merge assets + core + topical + Year 1 income into one person-level dataset
## ----------------------------------------------------------

dat <- assets_wide %>%
  inner_join(core7, by = id_vars) %>%
  inner_join(tm7,  by = id_vars) %>%
  left_join(year1_income, by = id_vars)

cat("Rows in merged dat: ", nrow(dat), "\n")

## ----------------------------------------------------------
## 6. Reproduce Stata sample flags: yr1jb1, temp, y401k, notmissing
## ----------------------------------------------------------

dat <- dat %>%
  mutate(
    # Age range: 22–64  (matches: keep if tage>21 & tage<65)
    age_ok = !is.na(tage) & tage >= 22 & tage <= 64,

    # For-profit: eclwrk1 == 1
    for_profit = (eclwrk1 == 1),

    # yr1jb1: began current job within the past year at Wave 7 (Stata logic)
    yr1jb1 = case_when(
      srotaton == 1 ~ tsjdate1 > 19970299,
      srotaton == 2 ~ tsjdate1 > 19970399,
      srotaton == 3 ~ tsjdate1 > 19970499,
      srotaton == 4 ~ tsjdate1 > 19970599,
      TRUE          ~ NA
    ),

    # Treatment: temp  (exactly the Stata definition)
    temp = as.integer(
      (enoina03 == 1 & etdeffen == 1) |   # "haven't worked long enough" & firm offers plan
      (enoinb03 == 1)
    ),

    # y401k: firm offers 401(k) (Stata: y401k = temp | e1taxdef==1 | e2taxdef==1 | e3taxdef==1 | (etdeffen==1 & yr1jb1))
    y401k = (temp == 1) |
            (e1taxdef == 1) |
            (e2taxdef == 1) |
            (e3taxdef == 1) |
            (etdeffen == 1 & yr1jb1 == 1),

    # Calculate d21ltaltb exactly as in Stata: ln(taltb12+10) - 2*(ln(taltb9+10)) + ln(taltb6+10)
    d21ltaltb = log(taltb12 + 10) - 2 * log(taltb9 + 10) + log(taltb6 + 10),

    # "notmissing" is defined via d21ltaltb ~= . in Stata
    # Check if d21ltaltb is not missing (which happens when any component calculation fails)
    notmissing = !is.na(d21ltaltb),

    # Income missing dummy (Stata's incmissing); here we allow missing, we just flag it.
    incmissing = as.integer(is.na(hh_inc_year))
  )

cat("Counts: y401k TRUE/FALSE:\n")
print(table(dat$y401k, useNA = "ifany"))
cat("Counts: temp (treatment) 0/1:\n")
print(table(dat$temp, useNA = "ifany"))

## ----------------------------------------------------------
## 7. Table 1 *sample* = Stata's "main" restrictions
## ----------------------------------------------------------
##    - age 22–64
##    - for-profit (eclwrk1==1)
##    - yr1jb1 == 1 (started job within the previous year)
##    - y401k == TRUE
##    - notmissing == TRUE  (has the data to construct d21ltaltb)
##
## This should land you very close to 835 total obs,
## with ~296 treated and the rest control.
## ----------------------------------------------------------

table1_sample <- dat %>%
  filter(
    age_ok,
    for_profit,
    yr1jb1 == 1,
    y401k,
    notmissing
  )

cat("Table 1 sample size: ", nrow(table1_sample), "\n")
cat("Treatment (temp==1): ", sum(table1_sample$temp == 1, na.rm = TRUE), "\n")
cat("Control   (temp==0): ", sum(table1_sample$temp == 0, na.rm = TRUE), "\n")

## Separate N for *income* row (Stata has 818 instead of 835)
income_sample <- table1_sample %>%
  filter(!is.na(hh_inc_year))

cat("Income row N (non-missing hh_inc_year): ", nrow(income_sample), "\n")

## ----------------------------------------------------------
## 8. Build Table 1 means/SDs (same variables as paper)
## ----------------------------------------------------------

w_mean_sd <- function(x, w) {
  x <- as.numeric(x)
  w <- as.numeric(w)
  ok <- !is.na(x) & !is.na(w)
  x  <- x[ok]; w <- w[ok]
  if (!length(x)) return(c(mean = NA_real_, sd = NA_real_))
  w  <- w / sum(w)
  mu <- sum(w * x)
  var <- sum(w * (x - mu)^2)
  c(mean = mu, sd = sqrt(var))
}

make_block <- function(df) {
  out <- list(
    Age                     = w_mean_sd(df$tage,        df$wpfinwgt),
    `Yearly household income` =
      w_mean_sd(df$hh_inc_year, df$wpfinwgt),
    `401(k) assets`         =
      w_mean_sd(df$taltb6,     df$wpfinwgt),
    `IRA and Keogh assets`  =
      w_mean_sd(df$thhira6,    df$wpfinwgt),
    `Other financial assets`=
      w_mean_sd(df$otherassets6, df$wpfinwgt),
    `Secured debt`          =
      w_mean_sd(df$thhscdbt6,  df$wpfinwgt),
    `Unsecured debt`        =
      w_mean_sd(df$rhhuscbt6,  df$wpfinwgt),
    `Car value`             =
      w_mean_sd(df$tcarval6,   df$wpfinwgt)
  )
  vals <- lapply(out, function(msd)
    sprintf("%.1f\n(%.1f)", msd["mean"], msd["sd"]))
  tibble::as_tibble_row(vals)
}

tab_all <- make_block(table1_sample) %>%
  mutate(group = "All",
         Observations = nrow(table1_sample))

tab_treat <- make_block(filter(table1_sample, temp == 1)) %>%
  mutate(group = "Treatment group",
         Observations = sum(table1_sample$temp == 1, na.rm = TRUE))

tab_ctrl <- make_block(filter(table1_sample, temp == 0)) %>%
  mutate(group = "Control group",
         Observations = sum(table1_sample$temp == 0, na.rm = TRUE))

table1 <- bind_rows(tab_all, tab_treat, tab_ctrl) %>%
  relocate(group, Observations)

table1

```
```{r}
  pivot_wider(names_from = month, values_from = THTOTINC, id_cols = all_of(id_vars))

```
```{r}
library(dplyr)
library(tidyr)

to_num <- function(x) suppressWarnings(as.numeric(x))




id_vars <- c("SSUID","SHHADID","EENTAID","EPPPNUM")


## 2. Assets: build taltb6, thhira6, otherassets6, etc.


make_assets_wave <- function(df, wave_num) {
  df %>%
    transmute(
      SSUID, SHHADID, EENTAID, EPPPNUM,
      wave = wave_num,
      # 401(k) balance
      taltb      = to_num(TALTB),
      # IRA balance
      thhira     = to_num(THHIRA),
      # Other financial assets (interest, stocks, other)
      otherassets = to_num(THHINTBK) +
                    to_num(THHINTOT) +
                    to_num(RHHSTK)   +
                    to_num(THHOTAST),
      # secured & unsecured debt
      thhscdbt   = to_num(THHSCDBT),
      rhhuscbt   = to_num(RHHUSCBT),
      # car values: sum over up to 3 cars
      tcarval    = to_num(TCARVAL1) +
                   to_num(TCARVAL2) +
                   to_num(TCARVAL3)
    )
}

assets_long <- bind_rows(
  make_assets_wave(t3,  3),
  make_assets_wave(t6,  6),
  make_assets_wave(t9,  9),
  make_assets_wave(t12, 12)
)

assets_wide <- assets_long %>%
  pivot_wider(
    id_cols    = all_of(id_vars),
    names_from = wave,
    values_from = c(taltb, thhira, otherassets, thhscdbt, rhhuscbt, tcarval),
    names_sep = ""
  )
# Gives: taltb3, taltb6, taltb9, taltb12, etc.


## 3. Wave 7 core (SREFMON==4 only) + RMESR (employment status)


core7 <- w7 %>%
  filter(SREFMON == 4) %>%  # rotation 4
  transmute(
    SSUID, SHHADID, EENTAID, EPPPNUM,
    tage      = to_num(TAGE),
    wpfinwgt  = to_num(WPFINWGT),
    eclwrk1   = to_num(ECLWRK1),
    efnp      = to_num(EFNP),
    esex      = to_num(ESEX),
    tempall1  = to_num(TEMPALL1),
    ejbind1   = to_num(EJBIND1),
    tsjdate1  = to_num(TSJDATE1),
    srotaton  = to_num(SROTATON),
    rmesr     = to_num(RMESR),         # <-- key new variable
    # Year-1 household income proxy
    hh_inc_year = to_num(THTOTINC)
  )


## 4. Topical module 7: 401(k) eligibility & reasons


tm7 <- t7 %>%
  transmute(
    SSUID, SHHADID, EENTAID, EPPPNUM,
    e1taxdef = to_num(E1TAXDEF),
    e2taxdef = to_num(E2TAXDEF),
    e3taxdef = to_num(E3TAXDEF),
    enoina03 = to_num(ENOINA03),   # reason: haven't worked long enough (plan A)
    enoinb03 = to_num(ENOINB03),   # reason: haven't worked long enough (plan B)
    etdeffen = to_num(ETDEFFEN)    # firm offers any tax-deferred plan
  )


## 5. Merge assets + core + topical


dat <- assets_wide %>%
  inner_join(core7, by = id_vars) %>%
  inner_join(tm7,  by = id_vars)

cat("Rows in merged dat: ", nrow(dat), "\n")


## 6. Flags: age_ok, for_profit, yr1jb1, temp, y401k, notmissing


dat <- dat %>%
  mutate(
    # Age 22–64
    age_ok = !is.na(tage) & tage >= 22 & tage <= 64,

    # For-profit: ECLWRK1 == 1
    for_profit = (eclwrk1 == 1),

    # Started job within previous year (Wave 7 rotation logic)
    yr1jb1 = case_when(
      srotaton == 1 ~ tsjdate1 > 19970299,
      srotaton == 2 ~ tsjdate1 > 19970399,
      srotaton == 3 ~ tsjdate1 > 19970499,
      srotaton == 4 ~ tsjdate1 > 19970599,
      TRUE          ~ NA
    ),

    # Treatment: "haven’t worked long enough" & firm offers plan
    temp = as.integer(
      (enoina03 == 1 & etdeffen == 1) |
      (enoinb03 == 1)
    ),

    # Firm offers 401(k)
    y401k = (temp == 1) |
            (e1taxdef == 1) |
            (e2taxdef == 1) |
            (e3taxdef == 1) |
            (etdeffen == 1 & yr1jb1 == 1),

    # “Notmissing” asset growth (based on 6/9/12 balances)
    notmissing = !is.na(taltb6) & !is.na(taltb9) & !is.na(taltb12),

    # Income missing dummy
    incmissing = as.integer(is.na(hh_inc_year))
  )

cat("Counts: y401k TRUE/FALSE/NA:\n")
print(table(dat$y401k, useNA = "ifany"))
cat("Counts: temp (treatment) 0/1:\n")
print(table(dat$temp, useNA = "ifany"))


## 7. Table 1 sample + RMESR filter (employment status)

## Stata analogue: keep if rmesr <= 4  (in labor force / recently worked)


table1_sample <- dat %>%
  filter(
    age_ok,           # 22–64
    for_profit,       # for-profit firm
    yr1jb1 == 1,      # started job within previous year
    y401k,            # firm offers 401(k)
    notmissing,       # have assets in 6/9/12
    !is.na(rmesr),
    rmesr <= 4        # <-- NEW: match authors’ labor-force restriction
  )

cat("Table 1 sample size: ", nrow(table1_sample), "\n")
cat("Treatment (temp==1): ", sum(table1_sample$temp == 1, na.rm = TRUE), "\n")
cat("Control   (temp==0): ", sum(table1_sample$temp == 0, na.rm = TRUE), "\n")

income_sample <- table1_sample %>%
  filter(!is.na(hh_inc_year))

cat("Income row N (non-missing hh_inc_year): ", nrow(income_sample), "\n")


## 8. Build Table 1 means/SDs


w_mean_sd <- function(x, w) {
  x <- as.numeric(x)
  w <- as.numeric(w)
  ok <- !is.na(x) & !is.na(w)
  x  <- x[ok]; w <- w[ok]
  if (!length(x)) return(c(mean = NA_real_, sd = NA_real_))
  w  <- w / sum(w)
  mu <- sum(w * x)
  var <- sum(w * (x - mu)^2)
  c(mean = mu, sd = sqrt(var))
}

make_block <- function(df) {
  out <- list(
    Age                     = w_mean_sd(df$tage,        df$wpfinwgt),
    `Yearly household income` =
      w_mean_sd(df$hh_inc_year, df$wpfinwgt),
    `401(k) assets`         =
      w_mean_sd(df$taltb6,     df$wpfinwgt),
    `IRA and Keogh assets`  =
      w_mean_sd(df$thhira6,    df$wpfinwgt),
    `Other financial assets`=
      w_mean_sd(df$otherassets6, df$wpfinwgt),
    `Secured debt`          =
      w_mean_sd(df$thhscdbt6,  df$wpfinwgt),
    `Unsecured debt`        =
      w_mean_sd(df$rhhuscbt6,  df$wpfinwgt),
    `Car value`             =
      w_mean_sd(df$tcarval6,   df$wpfinwgt)
  )
  vals <- lapply(out, function(msd)
    sprintf("%.1f\n(%.1f)", msd["mean"], msd["sd"]))
  tibble::as_tibble_row(vals)
}

tab_all <- make_block(table1_sample) %>%
  mutate(group = "All",
         Observations = nrow(table1_sample))

tab_treat <- make_block(filter(table1_sample, temp == 1)) %>%
  mutate(group = "Treatment group",
         Observations = sum(table1_sample$temp == 1, na.rm = TRUE))

tab_ctrl <- make_block(filter(table1_sample, temp == 0)) %>%
  mutate(group = "Control group",
         Observations = sum(table1_sample$temp == 0, na.rm = TRUE))

table1 <- bind_rows(tab_all, tab_treat, tab_ctrl) %>%
  relocate(group, Observations)

table1

```